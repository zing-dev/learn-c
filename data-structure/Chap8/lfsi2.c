#include "stdio.h"
#include "math.h"

/*======================================================
// ��������lfsi2
// ��������������ʽ����ػ���
// ���������a �������ޣ�b ��������,
//           n0 ��ʼ������
//           eps ����Ҫ��
//           f ָ�򱻻�������ָ��
//           fy ָ�����y���������޵ĺ�����ָ��
// ����ֵ��  ���ֽ���ֵ
=========================================================*/
double lfsi2(a, b, n0, eps, f, fy)

double a, b, eps, (*f)();
int n0;

void (*fy)();

{
int k, j, p, n, flag;
double z, z2, d, h, x, t1, t2;
double u, bb[8], hx[8];

double lfsg();

n = n0;                            /* ��ʼ�Ļ�����*/
h = (b - a) / n;                       /* ��ó�ʼ����*/
t1 = lfsg(a, n0, eps, f, fy);
t2 = lfsg(b, n0, eps, f, fy);
z = (t1 + t2) / 2.0;                   /* �����ʼ�Ļ���ֵ*/
for(
k = 1;
k<n;
k++)
{
x = a + k * h;
t1 = lfsg(x, n0, eps, f, fy);
z = z + t1;                        /* �۴����*/
}
z = z * h;
bb[0] =
z;                         /* ��ʼ����ֵ*/
u = z;                             /* u���ڴ������ʽ����Ľ��*/
p = 1;
hx[0] =
h;
do
{
z2 = 0.0;
for(
k = 0;
k<n;
k++)
{
x = a + (k + 0.5) * h;
t1 = lfsg(x, n0, eps, f, fy);
z2 = z2 + t1;
}
z2 = (z + h * z2) / 2.0;                /* �����µĻ���ֵ*/
z = z2;                          /* ���»���ֵ*/
h = h / 2.0;                       /* ���²���*/
n = 2 * n;                         /* ���»�����*/
flag = 0;
for(
j = 0;
j<p;
j++)               /* �����µ�����ʽ�ڵ�b[p]*/
{
if(
fabs(z2
-bb[j])<eps)         /* Ҫ�������������Ҫ��鷶Χ*/
{
flag = 1;
j = p;                       /* ������Ϊ0,������ʽ����Ϊֹ*/
}
else
z2 = (h - hx[j]) / (z2 - bb[j]);
}
hx[p] =
h;                       /* ��¼��������Ϊ����ʽ��ֵ�Ľ��*/
if(flag == 1)
bb[p] = 1.0e35;                 /* �������������ֹ����ʽ*/
else
bb[p] =
z2;
z2 = bb[p];                        /* ������h=0���Ľ���ֵ*/
for(
j = p - 1;
j>=0; j--)
z2 = bb[j] - hx[j] / z2;
d = fabs(z2 - u);
u = z2;
p = p + 1;
}while((d>eps) && (p<8) &&(flag==0));
return(u);
}

static double lfsg(t, n0, eps, f, fy)
double t, eps, (*f)();
int n0;

void (*fy)();

{
int k, j, p, n, flag;
double y[2], a, b;
double z, z2, u, d, h, x, bb[8], hx[8];
(*fy)(t,y);                        /* ����������*/
a = y[0];
b = y[1];
n = n0;                            /* ��ʼ�Ļ�����*/
h = (b - a) / n;                       /* ��ó�ʼ����*/
z = ((*f)(t, a) + (*f)(t, b)) / 2.0;         /* �����ʼ�Ļ���ֵ*/
for(
k = 1;
k<n;
k++)
{
x = a + k * h;
z = z + (*f)(t, x);                   /* �۴����*/
}
z = z * h;
bb[0] =
z;                         /* ��ʼ����ֵ*/
u = z;                             /* u���ڴ������ʽ����Ľ��*/
p = 1;
hx[0] =
h;
do
{
z2 = 0.0;
for(
k = 0;
k<n;
k++)
{
x = a + (k + 0.5) * h;
z2 = z2 + (*f)(t, x);
}
z2 = (z + h * z2) / 2.0;                /* �����µĻ���ֵ*/
z = z2;                          /* ���»���ֵ*/
h = h / 2.0;                       /* ���²���*/
n = 2 * n;                         /* ���»�����*/
flag = 0;
for(
j = 0;
j<p;
j++)               /* �����µ�����ʽ�ڵ�b[p]*/
{
if(
fabs(z2
-bb[j])<eps)         /* Ҫ�������������Ҫ��鷶Χ*/
{
flag = 1;
j = p;                       /* ������Ϊ0,������ʽ����Ϊֹ*/
}
else
z2 = (h - hx[j]) / (z2 - bb[j]);
}
hx[p] =
h;                       /* ��¼��������Ϊ����ʽ��ֵ�Ľ��*/
if(flag == 1)
bb[p] = 1.0e35;                 /* �������������ֹ����ʽ*/
else
bb[p] =
z2;
z2 = bb[p];                        /* ������h=0���Ľ���ֵ*/
for(
j = p - 1;
j>=0; j--)
z2 = bb[j] - hx[j] / z2;
d = fabs(z2 - u);
u = z2;
p = p + 1;
}while((d>eps) && (p<8) &&(flag==0));
return(u);
}

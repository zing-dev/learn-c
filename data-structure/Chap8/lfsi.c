#include "stdio.h"
#include "math.h"

/*======================================================
// ��������lfsi
// ��������������ʽ�����
// ���������a �������ޣ�b ��������,
//           n0 ��ʼ������
//           eps ����Ҫ��
//           f ָ�򱻻�������ָ��
// ����ֵ��  ���ֽ���ֵ
=========================================================*/
double lfsi(a, b, n0, eps, f)

double a, b, eps;
int n0;

double (*f)();

{
int k, j, p, n, flag;
double z, z2, u, t, d, h, x, bb[8], hx[8];

n = n0;                            /* ��ʼ�Ļ�����*/
h = (b - a) / n;                       /* ��ó�ʼ����*/
z = ((*f)(a) + (*f)(b)) / 2.0;         /* �����ʼ�Ļ���ֵ*/
for(
k = 1;
k<n;
k++)
{
x = a + k * h;
z = z + (*f)(x);                   /* �۴����*/
}
z = z * h;
bb[0] =
z;                         /* ��ʼ����ֵ*/
u = z;                             /* u���ڴ������ʽ����Ľ��*/
p = 1;
hx[0] =
h;
do
{
t = 0.0;
for(
k = 0;
k<n;
k++)
{
x = a + (k + 0.5) * h;
t = t + (*f)(x);
}
z2 = (z + h * t) / 2.0;                /* �����µĻ���ֵ*/
z = z2;                          /* ���»���ֵ*/
h = h / 2.0;                       /* ���²���*/
n = 2 * n;                         /* ���»�����*/
flag = 0;
for(
j = 0;
j<p;
j++)               /* �����µ�����ʽ�ڵ�b[p]*/
{
if(
fabs(z2
-bb[j])<eps)         /* Ҫ�������������Ҫ��鷶Χ*/
{
flag = 1;
j = p;                       /* ������Ϊ0,������ʽ����Ϊֹ*/
}
else
z2 = (h - hx[j]) / (z2 - bb[j]);
}
hx[p] =
h;                       /* ��¼��������Ϊ����ʽ��ֵ�Ľ��*/
if(flag == 1)
bb[p] = 1.0e35;                 /* �������������ֹ����ʽ*/
else
bb[p] =
z2;
z2 = bb[p];                        /* ������h=0���Ľ���ֵ*/
for(
j = p - 1;
j>=0; j--)
z2 = bb[j] - hx[j] / z2;
d = fabs(z2 - u);
u = z2;
p = p + 1;
}while((d>eps) && (p<8) &&(flag==0));
return(u);
}
